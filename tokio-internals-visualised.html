<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Understanding Eventloops (Tokio Internals) | Byte Vault</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://twistingtwists.github.io/byte_vault/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://twistingtwists.github.io/byte_vault/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://twistingtwists.github.io/byte_vault/tokio-internals-visualised"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Understanding Eventloops (Tokio Internals) | Byte Vault"><meta data-rh="true" name="description" content="Prelude"><meta data-rh="true" property="og:description" content="Prelude"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-04-19T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/TwistingTwists"><meta data-rh="true" property="article:tag" content="Rust,Tokio,Async,Event Loop"><link data-rh="true" rel="icon" href="/byte_vault/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://twistingtwists.github.io/byte_vault/tokio-internals-visualised"><link data-rh="true" rel="alternate" href="https://twistingtwists.github.io/byte_vault/tokio-internals-visualised" hreflang="en"><link data-rh="true" rel="alternate" href="https://twistingtwists.github.io/byte_vault/tokio-internals-visualised" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://twistingtwists.github.io/byte_vault/tokio-internals-visualised","mainEntityOfPage":"https://twistingtwists.github.io/byte_vault/tokio-internals-visualised","url":"https://twistingtwists.github.io/byte_vault/tokio-internals-visualised","headline":"Understanding Eventloops (Tokio Internals)","name":"Understanding Eventloops (Tokio Internals)","description":"Prelude","datePublished":"2025-04-19T00:00:00.000Z","author":{"@type":"Person","name":"Abhishek Tripathi","description":"Curiosity brings awareness.","url":"https://github.com/TwistingTwists","image":"https://github.com/TwistingTwists.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://twistingtwists.github.io/byte_vault/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/byte_vault/rss.xml" title="Byte Vault RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/byte_vault/atom.xml" title="Byte Vault Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B9R18KF2Y1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B9R18KF2Y1",{})</script>





<script src="/scripts/processMultiline.ts" async></script><link rel="stylesheet" href="/byte_vault/assets/css/styles.0f1f8831.css">
<script src="/byte_vault/assets/js/runtime~main.ee6b9d65.js" defer="defer"></script>
<script src="/byte_vault/assets/js/main.c49d4c0b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/byte_vault/img/logo.svg"><link rel="preload" as="image" href="https://github.com/TwistingTwists.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/byte_vault/"><div class="navbar__logo"><img src="/byte_vault/img/logo.svg" alt="Byte Vault" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/byte_vault/img/logo.svg" alt="Byte Vault" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Byte Vault</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/byte_vault/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/TwistingTwists/bytevault" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/database-isolation-visualised-dirty-reads">Database Isolation (dirty reads)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/byte_vault/tokio-internals-visualised">Understanding Eventloops (Tokio Internals)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/connection-pooling-in-depth">Connection Pooling - in Depth</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/reliable-structured-outputs-with-llms">Reliable Structured Outputs with LLMs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/string-interning-rust">String interning in Rust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/rust-tips-tricks">Rust tricks for the average developer (me)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/streaming-http-to-disk">Streaming HTTP to Disk</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/deep-flattening-in-rust-using-recursive-types">Deep Flattening in Rust - Using Recursive Types </a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/how-to-solve-reverse-proxy-performance-issues-in-caddy-server-a-300-performance-boost-using-unix-sockets">Caddy Reverse Proxy Performance: 300% Boost with Unix Sockets</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/byte_vault/1brc-same-tricks-across-languages">1brc - same tricks across languages</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Understanding Eventloops (Tokio Internals)</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-04-19T00:00:00.000Z">April 19, 2025</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/byte_vault/authors/abeeshake"><img class="avatar__photo authorImage_XqGP" src="https://github.com/TwistingTwists.png" alt="Abhishek Tripathi"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/byte_vault/authors/abeeshake"><span class="authorName_yefp">Abhishek Tripathi</span></a></div><small class="authorTitle_nd0D" title="Curiosity brings awareness.">Curiosity brings awareness.</small><div class="authorSocials_rSDt"><a href="https://x.com/twistin456" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a><a href="https://github.com/TwistingTwists" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><div class="tableOfContentsInline_prmo"><ul class="table-of-contents"><li><a href="#prelude">Prelude</a></li><li><a href="#multi-threaded-event-loop--server">Multi-Threaded Event Loop / Server</a></li><li><a href="#phase-0-the-problem">Phase 0: The Problem</a><ul><li><a href="#the-thread-per-connection-resource-drain">The Thread-Per-Connection Resource Drain</a></li></ul></li></ul></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prelude">Prelude<a href="#prelude" class="hash-link" aria-label="Direct link to Prelude" title="Direct link to Prelude">​</a></h2>
<p>This is the first post in a four part series that will provide an understanding of the mechanics behind the Tokio runtime in Rust. This post focuses on the challenges in a multi-threaded event loop that force us to think of async runtimes like Tokio.</p>
<p>Index of the four part series:</p>
<ol>
<li>Visualizing Tokio Internals: Part I - Multi-Threaded Event Loop / Server</li>
<li>Visualizing Tokio Internals: Part II - Reactor</li>
<li>Visualizing Tokio Internals: Part III - Wakers</li>
<li>Visualizing Tokio Internals: Part IV - Executors</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="multi-threaded-event-loop--server">Multi-Threaded Event Loop / Server<a href="#multi-threaded-event-loop--server" class="hash-link" aria-label="Direct link to Multi-Threaded Event Loop / Server" title="Direct link to Multi-Threaded Event Loop / Server">​</a></h2>
<p>What challenges in a multi-threaded event loop force us to think of async runtimes like Tokio?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="phase-0-the-problem">Phase 0: The Problem<a href="#phase-0-the-problem" class="hash-link" aria-label="Direct link to Phase 0: The Problem" title="Direct link to Phase 0: The Problem">​</a></h2>
<div class="my-3 sm:my-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 rounded-lg overflow-hidden shadow-sm dark:shadow-blue-900/5 border-l-4 border-blue-400 dark:border-blue-600"><div class="p-3 sm:p-4 space-y-2 sm:space-y-3"><div class="flex flex-wrap sm:flex-nowrap items-start sm:items-center gap-2 sm:gap-3"><div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto"><div class="flex-shrink-0 p-1.5 sm:p-2 bg-blue-100 dark:bg-blue-900/30 rounded-md group relative"><svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-label="Learning Objective"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg><div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-1.5 py-0.5 text-2xs sm:text-xs text-white bg-gray-800 dark:bg-gray-700 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">Learning Objective</div></div><div class="flex-grow min-w-0"><div class="text-xs sm:text-xs text-gray-600 dark:text-gray-400 mb-1 mt-0">After reading this you will be able to answer:</div><p class="text-sm sm:text-base font-medium text-blue-900 dark:text-blue-100 truncate">Why do we need async runtimes like Tokio?</p></div></div><button id="why-tokio-button" class="flex items-center gap-1 px-2 py-1 ml-auto text-2xs sm:text-xs font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200 focus:outline-none" aria-expanded="false" aria-controls="why-tokio">Show<svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div><div id="why-tokio" role="region" aria-labelledby="why-tokio-button" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0 opacity-0"><div class="pt-2 border-t border-blue-100 dark:border-blue-800 text-xs sm:text-sm text-gray-700 dark:text-gray-300"><ul>
<li><strong>Resource Efficiency:</strong> Traditional thread-per-connection models waste system resources</li>
<li><strong>Scalability:</strong> Async enables handling thousands of connections with minimal overhead</li>
<li><strong>Performance:</strong> Event-driven architecture reduces context switching and memory usage</li>
<li><strong>Cost-Effective:</strong> Better resource utilization means lower infrastructure costs</li>
</ul></div></div></div></div>
<!-- -->
<p>Modern applications, especially network services, need to handle many things concurrently. Imagine a web server handling thousands of client connections simultaneously.</p>
<p>A naive approach is to dedicate one Operating System (OS) thread to each connection. Let&#x27;s see why this doesn&#x27;t scale well.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-thread-per-connection-resource-drain">The Thread-Per-Connection Resource Drain<a href="#the-thread-per-connection-resource-drain" class="hash-link" aria-label="Direct link to The Thread-Per-Connection Resource Drain" title="Direct link to The Thread-Per-Connection Resource Drain">​</a></h3>
<p>The visualization below shows resource consumption (CPU/Memory) and throughput limits of a blocking thread-per-connection model.</p>
<div class="my-4 border rounded-lg border-gray-200 dark:border-gray-800"><button class="w-full px-4 py-3 flex items-center justify-between text-left bg-gray-50 dark:bg-gray-900 rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200" id="thread-per-connection" aria-expanded="false"><span class="font-medium text-gray-900 dark:text-gray-100">How a thread-per-connection server behaves as load increases</span><svg class="w-5 h-5 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="overflow-hidden transition-all duration-300 ease-in-out max-h-0 opacity-0"><div class="p-4 prose dark:prose-invert max-w-none"><p><strong>Description:</strong></p><p>Imagine a dashboard resembling <code>htop</code> or Task Manager:</p><ol>
<li><strong>CPU Usage:</strong> Bars representing individual CPU cores.</li>
<li><strong>Memory Usage:</strong> A single bar showing total RAM consumption.</li>
<li><strong>Active Threads:</strong> A counter or list showing running OS threads.</li>
<li><strong>Requests/Second:</strong> A throughput meter.</li>
<li><strong>Incoming Requests Queue:</strong> A visual queue of pending connections.</li>
</ol><p><strong>Simulation:</strong></p><ul>
<li><strong>Start:</strong> The server starts. CPU/Memory usage is low. Throughput is 0. Few base threads exist.</li>
<li><strong>Low Load:</strong> Simulate a few incoming connections (~10). For each, a new OS thread is created.<!-- -->
<ul>
<li><em>Visual:</em> Active Threads count increases slightly. Memory usage ticks up slightly. CPU usage might blip as threads start but stays relatively low if connections are mostly idle. Throughput matches the request rate.</li>
</ul>
</li>
<li><strong>High Load:</strong> Simulate hundreds or thousands of incoming connections. Many connections involve waiting for network I/O (reading request body, waiting for database, sending response).<!-- -->
<ul>
<li><em>Visual:</em>
<ul>
<li><strong>Active Threads:</strong> The count explodes. Each thread requires kernel resources and its own stack (~MBs).</li>
<li><strong>Memory Usage:</strong> The Memory bar shoots up dramatically, potentially hitting system limits.</li>
<li><strong>CPU Usage:</strong> CPU bars likely thrash. Even if threads are mostly <em>waiting</em> (blocked on I/O), the OS spends significant time <em>context switching</em> between them. This is overhead, not useful work.</li>
<li><strong>Requests Queue:</strong> The incoming requests queue grows rapidly because threads are created, but many quickly block on I/O. The server struggles to accept new connections.</li>
<li><strong>Requests/Second:</strong> The throughput meter hits a plateau far below the incoming request rate, possibly even decreasing as context-switching overhead dominates.</li>
</ul>
</li>
</ul>
</li>
</ul></div></div></div>
<div class="visualization-container bg-gray-100 dark:bg-gray-900 p-6 rounded-lg shadow-md space-y-6"><div class="bg-black dark:bg-gray-800 text-green-400 dark:text-green-300 p-4 rounded font-mono text-sm h-64 overflow-y-auto"><div class="mb-2"><span class="text-blue-400 dark:text-blue-300">htop - </span><span class="text-white dark:text-gray-100">Thread-Per-Connection Server</span></div><div class="mb-4"><div class="flex justify-between mb-1"><span>Active Connections:</span><span class="">10</span></div><div class="flex justify-between mb-1"><span>Threads:</span><span class="">12</span></div><div class="flex justify-between mb-1"><span>Requests/sec:</span><span class="text-red-500">0</span></div><div class="flex justify-between mb-1"><span>Request Queue:</span><span class="">0</span></div></div><div class="mb-4"><div class="text-white dark:text-gray-100 mb-1">CPU Usage</div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 0</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:5%"></div></div><span class="w-8 text-right">5%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 1</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:3%"></div></div><span class="w-8 text-right">3%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 2</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:4%"></div></div><span class="w-8 text-right">4%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 3</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:2%"></div></div><span class="w-8 text-right">2%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 4</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:5%"></div></div><span class="w-8 text-right">5%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 5</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:3%"></div></div><span class="w-8 text-right">3%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 6</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:2%"></div></div><span class="w-8 text-right">2%</span></div></div><div class="mb-2"><div class="flex items-center justify-between"><span class="w-12">CPU 7</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:4%"></div></div><span class="w-8 text-right">4%</span></div></div><div class="flex items-center justify-between mt-1"><span class="w-12">Average:</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-green-500 dark:bg-green-400" style="width:0%"></div></div><span class="w-8 text-right">0%</span></div></div><div class="mb-4"><div class="text-white dark:text-gray-100 mb-1">Memory Usage</div><div class="flex items-center justify-between"><span class="w-12">Mem</span><div class="w-full bg-gray-700 dark:bg-gray-600 h-4 ml-2 mr-2 rounded-sm"><div class="h-full rounded-sm bg-blue-500 dark:bg-blue-400" style="width:8%"></div></div><span class="w-8 text-right">8%</span></div></div><div><div class="text-white dark:text-gray-100 mb-1">Top Threads</div><div class="grid grid-cols-12 text-xs mb-1 border-b border-gray-700 dark:border-gray-600"><div class="col-span-1">PID</div><div class="col-span-3">USER</div><div class="col-span-1">PR</div><div class="col-span-1">NI</div><div class="col-span-2">CPU%</div><div class="col-span-2">MEM%</div><div class="col-span-2">CMD</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1000</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">5.0</div><div class="col-span-2">0.3</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1001</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">16.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1002</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">2.0</div><div class="col-span-2">0.3</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1003</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">10.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1004</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">15.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1005</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">5.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1006</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">3.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1007</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">8.0</div><div class="col-span-2">0.3</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1008</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">18.0</div><div class="col-span-2">0.4</div><div class="col-span-2">http-conn</div></div><div class="grid grid-cols-12 text-xs mb-1"><div class="col-span-1">1009</div><div class="col-span-3">server</div><div class="col-span-1">20</div><div class="col-span-1">0</div><div class="col-span-2">12.0</div><div class="col-span-2">0.3</div><div class="col-span-2">http-conn</div></div><div class="text-gray-500 dark:text-gray-400 text-xs mt-1">... and <!-- -->2<!-- --> more threads</div></div></div><div class="flex justify-between items-center"><h3 class="text-lg font-bold dark:text-gray-100">Thread-Per-Connection Resource Monitor</h3><div class="flex gap-4"><button class="px-6 py-3 rounded-lg font-medium text-white shadow-lg transform transition-all duration-200 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 active:scale-95 active:shadow-md border border-white/10 hover:shadow-xl hover:border-white/20 dark:border-white/20"><span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Start Simulation</span></button><button class="px-6 py-3 rounded-lg font-medium bg-gradient-to-r from-gray-600 to-gray-700 text-white shadow-lg transform transition-all duration-200 hover:from-gray-700 hover:to-gray-800 hover:scale-105 hover:-translate-y-0.5 hover:shadow-xl active:scale-95 active:shadow-md border border-white/10 hover:border-white/20 dark:border-white/20"><span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Reset</span></button></div></div><div class="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-6"><div><label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Simulate Connection Load</label><div class="flex gap-4 items-center"><input type="range" min="1" max="500" class="w-full" value="10"><span class="text-sm font-mono bg-gray-100 dark:bg-gray-900 dark:text-gray-100 p-1 rounded">10</span></div></div><div><label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Simulation Speed</label><div class="flex gap-4 items-center"><span class="text-xs">Slow</span><input type="range" min="0.5" max="5" step="0.5" class="w-full" value="1"><span class="text-xs">Fast</span><span class="text-sm font-mono bg-gray-100 dark:bg-gray-900 dark:text-gray-100 p-1 rounded">1<!-- -->x</span></div></div><div><h4 class="text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Performance Impact</h4><div class="relative h-64 border border-gray-300 dark:border-gray-600 rounded p-2"><div class="absolute bottom-0 left-0 right-0 border-t border-gray-300 dark:border-gray-600 flex justify-between px-2 text-xs text-gray-500 dark:text-gray-400"><div>0</div><div>100</div><div>200</div><div>300</div><div>400</div><div>500</div></div><div class="absolute left-0 top-0 bottom-10 flex items-center"><div class="transform -rotate-90 text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">Resource Utilization (%)</div></div><div class="absolute bottom-0 w-0.5 bg-red-500 h-full opacity-50" style="left:2%;height:calc(100% - 15px)"></div><div class="w-full h-full"></div><div class="absolute top-2 right-2 bg-white/80 dark:bg-gray-900/80 p-2 rounded text-xs space-y-1"><div class="flex items-center"><div class="w-3 h-3 bg-green-500 dark:bg-green-400 mr-2"></div><div>CPU Usage</div></div><div class="flex items-center"><div class="w-3 h-3 bg-blue-500 dark:bg-blue-400 mr-2"></div><div>Memory Usage</div></div><div class="flex items-center"><div class="w-3 h-3 bg-gray-500 dark:bg-gray-400 mr-2"></div><div>Thread Count</div></div><div class="flex items-center"><div class="w-3 h-3 bg-red-500 dark:bg-red-400 mr-2"></div><div>Throughput</div></div><div class="flex items-center"><div class="w-3 h-3 bg-purple-500 dark:bg-purple-400 mr-2"></div><div>Request Queue</div></div></div></div></div><div class="p-3 rounded border-2 bg-green-100 dark:bg-green-900 border-green-300 dark:border-green-700"><h4 class="font-medium mb-1 dark:text-gray-100">System Status:</h4><p class="text-sm dark:text-gray-200">System is handling connections efficiently. Resources are well-utilized with minimal overhead.</p></div></div><div class="text-center text-sm text-gray-600 dark:text-gray-300"><strong>Figure 1:</strong> Interactive visualization of thread-per-connection scaling issues. As connection count increases, resources are consumed by thread overhead, while throughput plateaus and then declines due to context switching costs.</div></div>
<div class="bg-orange-100 dark:bg-orange-900 p-6 rounded-xl mt-8 mb-4 border-l-4 border-orange-400 dark:border-orange-500 shadow-sm"><span class="block font-bold text-lg text-orange-900 dark:text-orange-200 mb-2">Insight</span><span class="text-base text-gray-900 dark:text-gray-100"><p>We need a way to handle multiple waiting tasks concurrently without needing a dedicated OS thread for each one <em>while it&#x27;s waiting</em>. This leads to asynchronous programming.</p></span></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="Rust lang" class="tag_zVej tagRegular_sFm0" href="/byte_vault/tags/rust">Rust</a></li><li class="tag_QGVx"><a title="Tokio async runtime" class="tag_zVej tagRegular_sFm0" href="/byte_vault/tags/tokio">Tokio</a></li><li class="tag_QGVx"><a title="Asynchronous programming" class="tag_zVej tagRegular_sFm0" href="/byte_vault/tags/async">Async</a></li><li class="tag_QGVx"><a title="Event loop" class="tag_zVej tagRegular_sFm0" href="/byte_vault/tags/eventloop">Event Loop</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/byte_vault/database-isolation-visualised-dirty-reads"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Database Isolation (dirty reads)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/byte_vault/connection-pooling-in-depth"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Connection Pooling - in Depth</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prelude" class="table-of-contents__link toc-highlight">Prelude</a></li><li><a href="#multi-threaded-event-loop--server" class="table-of-contents__link toc-highlight">Multi-Threaded Event Loop / Server</a></li><li><a href="#phase-0-the-problem" class="table-of-contents__link toc-highlight">Phase 0: The Problem</a><ul><li><a href="#the-thread-per-connection-resource-drain" class="table-of-contents__link toc-highlight">The Thread-Per-Connection Resource Drain</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/byte_vault/">Blog</a></li><li class="footer__item"><a href="https://github.com/TwistingTwists/bytevault" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2025 Abhishek Tripathi</div></div></div></footer></div>
</body>
</html>